<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RoadSafe ‚Äî Prompt Studio</title>

  <style>
    /* ---- Base ---- */
    :root{
      --bg-1: #0f1724;
      --bg-2: #020617;
      --card-bg: rgba(255,255,255,0.04);
      --muted: #9aa4b2;
      --accent-start: #06b6d4;
      --accent-end: #10b981;
      --glass: rgba(255,255,255,0.03);
      --light-bg: #f4f7fb;
      --light-card: #ffffff;
    }

    html,body{
      height:100%;
      margin:0;
      font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;
      -webkit-font-smoothing:antialiased;
      position:relative;
    }

    body {
      background-image: url('../bckgrd1.avif'), radial-gradient(1200px 600px at 10% 10%, rgba(6,182,212,0.06), transparent 8%), linear-gradient(180deg,var(--bg-1),var(--bg-2));
      background-size: cover, auto, auto;
      background-position: center, 10% 10%, 0 0;
      background-attachment: fixed, fixed, fixed;
      color: #ffffff;
      padding:36px;
      transition: background-image .28s ease;
      display:flex;
      justify-content:center;
      animation: rotateBackground 45s linear infinite;
    }

    @keyframes rotateBackground {
      0% {
        background-image: url('../bckgrd1.avif'), radial-gradient(1200px 600px at 10% 10%, rgba(6,182,212,0.06), transparent 8%), linear-gradient(180deg,var(--bg-1),var(--bg-2));
      }
      33.33% {
        background-image: url('../bckgrd2.png'), radial-gradient(1200px 600px at 10% 10%, rgba(6,182,212,0.06), transparent 8%), linear-gradient(180deg,var(--bg-1),var(--bg-2));
      }
      66.66% {
        background-image: url('../bckgrd3.png'), radial-gradient(1200px 600px at 10% 10%, rgba(6,182,212,0.06), transparent 8%), linear-gradient(180deg,var(--bg-1),var(--bg-2));
      }
      100% {
        background-image: url('../bckgrd1.avif'), radial-gradient(1200px 600px at 10% 10%, rgba(6,182,212,0.06), transparent 8%), linear-gradient(180deg,var(--bg-1),var(--bg-2));
      }
    }

    .wrap {
      width:100%;
      max-width:1100px;
      position:relative;
    }

    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:18px;
    }

    .brand {
      display:flex;
      gap:14px;
      align-items:flex-start;
    }
    
    .brand > div:last-child {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .logo {
      width:120px;
      height:120px;
      border-radius:18px;
      background:transparent;
      box-shadow: none;
      display:flex;
      align-items:center;
      justify-content:center;
      color:#012;
      font-weight:700;
      font-size:20px;
      overflow:hidden;
      transition: transform .25s ease;
    }
    
    .logo img {
      width:100%;
      height:100%;
      object-fit:cover;
    }

    h1{
      margin:0;
      font-size:32px;
      font-weight:800;
      line-height:1;
      background: rgba(15, 23, 36, 0.6);
      padding: 12px 16px;
      border-radius: 10px;
    }

    p.lead { margin:0; color:#dff7f5; font-size:13px; background: rgba(15, 23, 36, 0.5); padding: 8px 12px; border-radius: 8px; font-weight: 600; }

    .controls { display:flex; gap:10px; align-items:center; }

    .toggle {
      /* Match the primary button (generate) style */
      background: linear-gradient(90deg,var(--accent-start),var(--accent-end));
      color: #062024;
      border: none;
      padding: 10px 14px;
      border-radius: 10px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-weight: 700;
      box-shadow: 0 8px 20px rgba(6,182,212,0.12);
      transition: transform .18s, box-shadow .18s;
    }
    .toggle:hover{
      transform: translateY(-2px);
      box-shadow: 0 12px 28px rgba(6,182,212,0.18);
    }

    .panel {
      margin-top:24px;
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border:1px solid rgba(255,255,255,0.04);
      border-radius:20px;
      padding:28px;
      box-shadow: 0 10px 36px rgba(2,6,23,0.45);
      backdrop-filter: blur(6px);
      position:relative;
    }

    /* Temporary visible marker to confirm template changes */
    .debug-updated {
      display:inline-block;
      background: #10b981;
      color: #062024;
      padding:6px 10px;
      border-radius:8px;
      font-weight:800;
      margin-bottom:12px;
      box-shadow: 0 6px 18px rgba(16,185,129,0.12);
    }

    label{ font-size:16px; color:#dff7f5; display:block; margin-bottom:10px; font-weight:800; }

    textarea.input {
      width:1000px;
      min-height:50px;
      border-radius:14px;
      /* Make opaque black in dark mode for maximum contrast */
      background: rgba(0,0,0,0.95);
      border:1px solid rgba(255,255,255,0.12);
      color: #ffffff;
      padding:18px 22px 18px 18px;
      font-size:16px;
      resize:vertical;
      outline:none;
      box-shadow: 0 8px 30px rgba(2,6,23,0.25);
      transition: box-shadow .18s, border-color .18s, transform .18s;
    }

    /* Placeholder styling for dark theme (default) */
    textarea.input::placeholder {
      color: #ffffff;
      opacity: 0.85; /* ensure slightly softer than full white */
    }

    textarea.input:focus {
      border-color: var(--accent-start);
      box-shadow: 0 12px 36px rgba(6,182,212,0.12);
      transform: translateY(-2px);
    }

    .actions {
      display:flex;
      gap:14px;
      justify-content:flex-end;
      margin-top:16px;
    }

    .btn {
      background: linear-gradient(90deg,var(--accent-start),var(--accent-end));
      color:#062024;
      border:none;
      padding:10px 14px;
      border-radius:10px;
      cursor:pointer;
      font-weight:700;
      box-shadow: 0 8px 20px rgba(6,182,212,0.12);
      transition: transform .18s, box-shadow .18s;
    }
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 28px rgba(6,182,212,0.18);
    }
    .btn.secondary {
      background: linear-gradient(90deg,var(--accent-start),var(--accent-end));
      border: none;
      color: #062024;
      font-weight:700;
      box-shadow: 0 8px 20px rgba(6,182,212,0.12);
      transition: transform .18s, box-shadow .18s;
    }
    .btn.secondary:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 28px rgba(6,182,212,0.18);
    }

    .suggestions {
      margin-top:12px;
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
      gap:10px;
    }

    .suggestion {
      padding:10px 12px;
      border-radius:10px;
      /* Dark-blue suggestion cards for better contrast in dark theme */
      background: linear-gradient(180deg, rgba(4,36,67,0.95), rgba(2,20,38,0.98));
      border: 1px solid rgba(6,82,120,0.14);
      cursor:pointer;
      color: #ffffff; /* match placeholder color */
      opacity: 0.95;    /* slightly softened like placeholder */
      font-size:14px;
      transition: transform .12s, background .12s, color .12s, box-shadow .12s;
      box-shadow: 0 6px 18px rgba(2,6,23,0.45);
    }
    .suggestion:hover{
      transform:translateY(-4px);
      background: linear-gradient(180deg, rgba(6,38,72,1), rgba(6,34,64,1));
      color:#dff7f5;
      box-shadow: 0 10px 28px rgba(6,182,212,0.08);
    }

    .outputs {
      margin-top:22px;
      display:grid;
      grid-template-columns: repeat(auto-fit,minmax(280px,1fr));
      gap:16px;
    }

    .card {
      /* Navy-blue output card background for dark theme */
      background: linear-gradient(180deg, rgba(2,30,56,0.95), rgba(8,24,46,0.98));
      border-radius:14px;
      padding:14px;
      border:1px solid rgba(8,54,100,0.12);
      box-shadow: 0 10px 36px rgba(2,6,23,0.45);
      color: #e6eef6;
      line-height:1.5;
      white-space:pre-wrap;
    }

    .card h4 { margin:6px 0 6px; font-size:13px; color:#9ee9e1; font-weight:700; }
    .card .section-title { font-size:13px; color:var(--muted); margin:8px 0 6px; font-weight:700; }

    .meta { display:flex; justify-content:space-between; align-items:center; color:var(--muted); font-size:12px; margin-top:10px; }

    .spinner {
      width:18px;height:18px;border-radius:50%;border:3px solid rgba(255,255,255,0.08);border-left-color:var(--accent-start); animation:spin 1s linear infinite;
    }
    @keyframes spin{ from {transform:rotate(0)} to {transform:rotate(360deg)} }

    .light {
      --bg-1: #e6f2f1;
      --bg-2: #f4fbfe;
      color: #000;
      --muted: #333;
      --card-bg: rgba(0,0,0,0.02);
      --glass: rgba(0,0,0,0.03);
    }
    
    .light body {
      background-image: url('../bckgrd1.avif'), radial-gradient(1200px 600px at 10% 10%, rgba(6,182,212,0.06), transparent 8%), linear-gradient(180deg,var(--bg-1),var(--bg-2));
      animation: rotateBackground 45s linear infinite;
    }
    
    .light .panel, .light .card, .light .suggestion {
      background: var(--light-card);
      color: #000;
      border: 1px solid rgba(2,6,23,0.04);
      box-shadow: 0 6px 20px rgba(3,7,18,0.04);
    }
    .light .input {
      color: #000;
      background: transparent;
    }
    .light .input::placeholder {
      color: #999;
    }
    .light label {
      color: #000;
    }
    .light .btn {
      color: #000;
    }
    .light .toggle {
      color: #000;
    }
    .light .compact-card {
      color: #000;
    }
    .light .modal-content {
      color: #000;
    }
    .light .section-title {
      color: #000;
    }
    .light .timestamp {
      color: #666;
    }
    .light .prompt-text {
      color: #000;
    }
    .light .card {
      color: #000;
    }
    .light .modal-results .card {
      color: #000;
    }
    /* Light theme compact card text is white for contrast */
    .light .compact-card .prompt-text {
      color: #ffffff !important;
    }
    .light .compact-card .timestamp {
      color: #e0e0e0 !important;
    }
    
    .light h1 {
      background: rgba(230, 242, 241, 0.85);
      color: #000;
    }
    
    .light p.lead {
      background: rgba(230, 242, 241, 0.75);
      color: #333;
    }

    @media (max-width:720px){
      body{ padding:18px }
      .logo{ width:80px;height:80px }
      h1 { font-size:18px; }
      .compact-card .prompt-text { font-size:14px; }
    }

    /* Fade animations */
    .separator-fade, .card-fade {
      opacity: 0;
      transform: translateY(10px);
      transition: opacity 0.6s ease, transform 0.6s ease;
    }
    .separator-fade.show, .card-fade.show {
      opacity: 1;
      transform: translateY(0);
    }

    /* Robot flying animation */
    @keyframes robotFly {
      0% {
        opacity: 1;
        transform: translate(0, 0) scale(1);
        z-index: 999;
      }
      50% {
        opacity: 1;
        transform: translate(var(--tx), var(--ty)) scale(1);
        z-index: 999;
      }
      100% {
        opacity: 1;
        transform: translate(0, 0) scale(1);
        z-index: 999;
      }
    }

    .robot-flying {
      position: fixed !important;
      animation: robotFly 5s ease-in-out forwards;
      z-index: 9999 !important;
    }

    /* Loading overlay */
    #loadingOverlay {
      position:fixed;
      top:0; left:0;
      width:100%; height:100%;
      background: rgba(15,23,36,0.75);
      display:flex;
      justify-content:center;
      align-items:center;
      flex-direction:column;
      z-index:1000;
      display:none;
      color:#fff;
      font-size:16px;
      backdrop-filter: blur(3px);
    }

    #loadingOverlay .spinner {
      width:36px; height:36px;
      border-width:4px;
      margin-bottom:12px;
      border-left-color:#10b981;
    }

    /* Modal Dialog */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(15, 23, 36, 0.85);
      z-index: 2000;
      justify-content: center;
      align-items: center;
      backdrop-filter: blur(4px);
    }
    .modal.open {
      display: flex;
    }
    .modal-content {
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border: 1px solid rgba(255,255,255,0.04);
      border-radius: 20px;
      padding: 28px;
      max-width: 800px;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(2, 6, 23, 0.6);
    }
    .modal-close {
      position: absolute;
      top: 16px;
      right: 16px;
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.08);
      color: #dff7f5;
      width: 36px;
      height: 36px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background .18s;
    }
    .modal-close:hover {
      background: rgba(255,255,255,0.06);
    }

    /* Compact card - shows only prompt and timestamp */
    .compact-card {
      /* match .card for consistency */
      background: linear-gradient(180deg, rgba(2,30,56,0.95), rgba(8,24,46,0.98));
      border-radius: 14px;
      padding: 16px;
      border: 1px solid rgba(255,255,255,0.04);
      box-shadow: 0 8px 30px rgba(2,6,23,0.45);
      color: inherit;
      cursor: pointer;
      transition: transform .18s, box-shadow .18s;
    }
    .compact-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 36px rgba(16, 185, 129, 0.12);
      border-color: rgba(16, 185, 129, 0.2);
    }
    .compact-card .prompt-text {
      font-weight: 600;
      color: #dff7f5;
      margin-bottom: 8px;
      line-height: 1.4;
    }
    .compact-card .timestamp {
      font-size: 12px;
      color: var(--muted);
    }

    /* Full results in modal */
    .modal-results {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 16px;
      margin-top: 16px;
    }
    .modal-results .card {
      margin: 0;
    }

  </style>
</head>

<body>
  <div class="wrap" id="app">
    <header>
      <div class="brand">
        <div class="logo"><img src="/robot.png" alt="RoadSafe" /></div>
        <div>
          <h1>RoadSafe ‚Äî Prompt Studio</h1>
          <p class="lead">Generate interventions & explanations to improve road safety</p>
        </div>
      </div>

      <div class="controls">
        <div id="themeBtn" class="toggle" title="Toggle theme">üåô Dark</div>
      </div>
    </header>

    <div class="panel" style="margin-top:20px;">
      <label for="prompt">Enter a prompt</label>
      <textarea id="prompt" class="input" placeholder="e.g. Frequent accidents at the junction near the market..."></textarea>

      <div class="actions">
        <button id="clearBtn" class="btn secondary">Clear</button>
        <button id="genBtn" class="btn">Generate</button>
      </div>

      <div id="suggestions" class="suggestions" aria-hidden="true" style="display:none; margin-top:14px;"></div>
    </div>

    <div id="outputs" class="outputs"></div>
  </div>

  <!-- Loading Overlay -->
  <div id="loadingOverlay">
    <div class="spinner"></div>
    <div>Generating results...</div>
  </div>

  <script>
    const BACKEND_URL = "http://127.0.0.1:5000/query";
    const promptEl = document.getElementById('prompt');
    const genBtn = document.getElementById('genBtn');
    const clearBtn = document.getElementById('clearBtn');
    const outputsContainer = document.getElementById('outputs');
    const suggestionsContainer = document.getElementById('suggestions');
    const themeBtn = document.getElementById('themeBtn');
    const loadingOverlay = document.getElementById('loadingOverlay');

    let suggestionList = [
      "Traffic congestion near school zone",
      "Frequent accidents at intersection",
      "Speeding vehicles in residential area",
      "Poor street lighting at night",
      "Pedestrians crossing without signals",
      "Bad road surface causing skids",
      "Motorcyclists not wearing helmets",
      "Vehicles overtaking on blind curves"
    ];

    let light = false;
    function setTheme(isLight){
      light = !!isLight;
      document.body.classList.toggle('light', light);
      themeBtn.textContent = light ? 'üåô Dark' : '‚òÄÔ∏è Light';
    }
    themeBtn.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      const clickElement = document.createElement('div');
      clickElement.style.position = 'fixed';
      clickElement.style.left = e.clientX + 'px';
      clickElement.style.top = e.clientY + 'px';
      clickElement.style.width = '1px';
      clickElement.style.height = '1px';
      clickElement.style.pointerEvents = 'none';
      document.body.appendChild(clickElement);
      animateRobotToElement(clickElement, () => setTheme(!light));
      setTimeout(() => clickElement.remove(), 5000);
    }, true);
    setTheme(false);

    function showSuggestions(query){
      if(!query || !query.trim()){
        suggestionsContainer.style.display='none';
        suggestionsContainer.innerHTML='';
        return;
      }
      const q = query.toLowerCase();
      const filtered = suggestionList.filter(s => s.toLowerCase().includes(q)).slice(0,8);
      if(filtered.length === 0){
        suggestionsContainer.style.display='none';
        suggestionsContainer.innerHTML='';
        return;
      }
      suggestionsContainer.style.display='grid';
      suggestionsContainer.innerHTML = filtered.map(s => `<div class="suggestion">${escapeHtml(s)}</div>`).join('');
    }

    promptEl.addEventListener('input', (e) => showSuggestions(e.target.value));

    clearBtn.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      const clickElement = document.createElement('div');
      clickElement.style.position = 'fixed';
      clickElement.style.left = e.clientX + 'px';
      clickElement.style.top = e.clientY + 'px';
      clickElement.style.width = '1px';
      clickElement.style.height = '1px';
      clickElement.style.pointerEvents = 'none';
      document.body.appendChild(clickElement);
      animateRobotToElement(clickElement, () => {
        promptEl.value = '';
        suggestionsContainer.style.display='none';
        promptEl.focus();
      });
      setTimeout(() => clickElement.remove(), 5000);
    }, true);

    function setLoading(v){
      genBtn.disabled = v;
      loadingOverlay.style.display = v ? 'flex' : 'none';
      if(v){
        genBtn.innerHTML = '<span class="spinner"></span> Generating';
      } else {
        genBtn.innerHTML = 'Generate';
      }
    }

    async function triggerGenerate(){
      const q = promptEl.value.trim();
      if(!q) return;

      setLoading(true);

      try {
        const res = await fetch(BACKEND_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ query: q })
        });

        const data = await res.json();
        if(data.error){
          showErrorCard('Server error', data.error);
        } else {
          renderOutputCard(q, data.output);
          promptEl.value = '';
          suggestionsContainer.style.display='none';
        }
      } catch(err){
        showErrorCard('Network error', 'Could not connect to backend. Is Flask running on http://127.0.0.1:5000?');
        console.error(err);
      } finally {
        setLoading(false);
      }
    }

    function animateRobotToElement(targetElement, onMidpoint = null) {
      const logoElement = document.querySelector('.logo');

      if (!logoElement || !targetElement) return;

      // Get positions (viewport coordinates)
      const logoRect = logoElement.getBoundingClientRect();
      const btnRect = targetElement.getBoundingClientRect();

      // Store original position for restoration
      const originalPos = logoElement.style.position;
      const originalLeft = logoElement.style.left;
      const originalTop = logoElement.style.top;

      // Calculate desired translation to center the logo on the target
      let tx = btnRect.left - logoRect.left + (btnRect.width - logoRect.width) / 2;
      let ty = btnRect.top - logoRect.top + (btnRect.height - logoRect.height) / 2;

      // Ensure the robot stays within the viewport (10px padding)
      const padding = 10;
      const desiredLeft = logoRect.left + tx;
      const minLeft = padding;
      const maxLeft = window.innerWidth - padding - logoRect.width;
      const clampedLeft = Math.min(maxLeft, Math.max(minLeft, desiredLeft));
      tx = clampedLeft - logoRect.left;

      const desiredTop = logoRect.top + ty;
      const minTop = padding;
      const maxTop = window.innerHeight - padding - logoRect.height;
      const clampedTop = Math.min(maxTop, Math.max(minTop, desiredTop));
      ty = clampedTop - logoRect.top;

      // Apply fixed positioning and animation
      logoElement.style.position = 'fixed';
      logoElement.style.left = logoRect.left + 'px';
      logoElement.style.top = logoRect.top + 'px';
      logoElement.style.setProperty('--tx', tx + 'px');
      logoElement.style.setProperty('--ty', ty + 'px');
      logoElement.classList.add('robot-flying');

      // Trigger callback at midpoint (2.5s)
      setTimeout(() => {
        if (onMidpoint) onMidpoint();
      }, 2500);

      // Remove animation and restore position after it completes
      setTimeout(() => {
        logoElement.classList.remove('robot-flying');
        logoElement.style.position = originalPos;
        logoElement.style.left = originalLeft;
        logoElement.style.top = originalTop;
      }, 5000);
    }

    genBtn.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      const clickElement = document.createElement('div');
      clickElement.style.position = 'fixed';
      clickElement.style.left = e.clientX + 'px';
      clickElement.style.top = e.clientY + 'px';
      clickElement.style.width = '1px';
      clickElement.style.height = '1px';
      clickElement.style.pointerEvents = 'none';
      document.body.appendChild(clickElement);
      animateRobotToElement(clickElement, triggerGenerate);
      setTimeout(() => clickElement.remove(), 5000);
    }, true);

    function renderOutputCard(promptText, dataArray) {
      if (!Array.isArray(dataArray)) dataArray = [dataArray];

      const timestamp = new Date().toLocaleString();
      const cardId = 'card-' + Date.now();
      const hasResults = dataArray && dataArray.length > 0 && dataArray.some(item => item && Object.keys(item).length > 0);

      // Create compact card
      const compactCard = document.createElement('div');
      compactCard.className = 'compact-card card-fade';
      compactCard.style.cursor = 'pointer';
      compactCard.innerHTML = `
        <div class="prompt-text">üìå ${escapeHtml(promptText)}</div>
        <div class="timestamp">Generated: ${timestamp}</div>
      `;

      // Create modal for full results
      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.id = cardId + '-modal';
      modal.innerHTML = `
        <div class="modal-content">
          <button class="modal-close">‚úï</button>
          <div class="modal-header" style="margin-bottom: 20px;">
            <h3 style="margin: 0 0 8px 0; color: #dff7f5;">Results for: ${escapeHtml(promptText)}</h3>
            <div style="font-size: 12px; color: var(--muted);">Generated: ${timestamp}</div>
          </div>
          <div class="modal-results">
            ${hasResults ? dataArray.map((item, idx) => `
              <div class="card">
                <div>
                  <div class="section-title">Result ${idx + 1}</div>
                  ${item.Problem ? `<div><strong>Problem:</strong> ${escapeHtml(item.Problem)}</div>` : ''}
                  ${item.Fix ? `<div><strong>Fix:</strong> ${escapeHtml(item.Fix)}</div>` : ''}
                  ${item.Type ? `<div><strong>Type:</strong> ${escapeHtml(item.Type)}</div>` : ''}
                  ${item['Possible Interventions'] ? `<div><strong>Possible Interventions:</strong> ${escapeHtml(item['Possible Interventions'].join(', '))}</div>` : ''}
                  ${item.Reasoning ? `<div><strong>Reasoning:</strong> ${escapeHtml(item.Reasoning)}</div>` : ''}
                </div>
              </div>
            `).join('') : `
              <div style="text-align: center; padding: 40px 20px; color: var(--muted); font-size: 16px;">
                <div style="font-size: 40px; margin-bottom: 12px;">‚ö†Ô∏è</div>
                <div>No relevant data found</div>
              </div>
            `}
          </div>
        </div>
      `;

      // Close modal on background click
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          modal.classList.remove('open');
        }
      });

      // Add to DOM
      outputsContainer.insertBefore(compactCard, outputsContainer.firstChild);
      document.body.appendChild(modal);

      // Store modal reference on card for global handler
      compactCard.dataset.modalId = cardId + '-modal';

      // Fade in animation
      requestAnimationFrame(() => {
        compactCard.classList.add('show');
      });
    }

    function escapeHtml(str){
      return String(str).replace(/[&<>"'`=\/]/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','`':'&#x60;','=':'&#x3D;'})[s]);
    }

    function showErrorCard(title, message){
      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `
        <div class="section-title">${escapeHtml(title)}</div>
        <div style="color:var(--muted)">${escapeHtml(message)}</div>
        <div class="meta"><div></div><div>${new Date().toLocaleString()}</div></div>
      `;
      outputsContainer.appendChild(card);
    }

    document.addEventListener('click', (e) => {
      // Hide suggestions if clicking outside
      if(!suggestionsContainer.contains(e.target) && e.target !== promptEl){
        suggestionsContainer.style.display='none';
      }

      // Animate robot to interactive elements (but not on textarea, buttons, or logo itself)
      const isInteractive = e.target.closest('.suggestion, .compact-card, .modal-close');
      const isExcluded = e.target.closest('textarea, .logo, .btn, input, .toggle') || e.target === promptEl;
      
      if (isInteractive && !isExcluded) {
        // Prevent immediate action
        e.preventDefault();
        e.stopPropagation();
        
        // Create a virtual element at the click point for animation
        const clickElement = document.createElement('div');
        clickElement.style.position = 'fixed';
        clickElement.style.left = e.clientX + 'px';
        clickElement.style.top = e.clientY + 'px';
        clickElement.style.width = '1px';
        clickElement.style.height = '1px';
        clickElement.style.pointerEvents = 'none';
        document.body.appendChild(clickElement);

        // Define deferred action
        const executeAction = () => {
          if (e.target.closest('.suggestion')) {
            const suggestionText = e.target.textContent;
            promptEl.value = suggestionText;
            suggestionsContainer.style.display = 'none';
          } else if (e.target.closest('.compact-card')) {
            const card = e.target.closest('.compact-card');
            const modalId = card.dataset.modalId;
            if (modalId) {
              const modal = document.getElementById(modalId);
              if (modal) modal.classList.add('open');
            }
          } else if (e.target.closest('.modal-close')) {
            const modal = e.target.closest('.modal');
            if (modal) modal.classList.remove('open');
          }
        };

        // Animate robot to suggestion element, then fill the text
        if (e.target.closest('.suggestion')) {
          const suggestionElement = e.target.closest('.suggestion');
          if (suggestionElement) {
            const suggestionRect = suggestionElement.getBoundingClientRect();
            clickElement.style.left = (suggestionRect.left + suggestionRect.width / 2) + 'px';
            clickElement.style.top = (suggestionRect.top + suggestionRect.height / 2) + 'px';
          }
          // Deferred action: fill textarea when robot reaches suggestion
          const suggestionText = e.target.textContent;
          animateRobotToElement(clickElement, () => {
            promptEl.value = suggestionText;
            suggestionsContainer.style.display = 'none';
          });
          setTimeout(() => clickElement.remove(), 5000);
          return;
        }

        // Animate robot to click point with deferred action
        animateRobotToElement(clickElement, executeAction);

        // Clean up after animation
        setTimeout(() => {
          clickElement.remove();
        }, 5000);
      }
    });
  </script>
</body>
</html>
